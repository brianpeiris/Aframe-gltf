THREE.GLTFLoader=function(){function e(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager}function t(){var e={};return{get:function(t){return e[t]},add:function(t,r){e[t]=r},remove:function(t){delete e[t]},removeAll:function(){e={}},update:function(t,r){for(var n in e){var a=e[n];a.update&&a.update(t,r)}}}}function r(e,t){var r={},n=e.material.uniforms;for(var a in n){var i=n[a];if(i.semantic){var s=i.node,o=e;s&&(o=t[s]),r[a]={semantic:i.semantic,sourceNode:o,targetNode:e,uniform:i}}}this.boundUniforms=r,this._m4=new THREE.Matrix4}function n(e){this.name=d.KHR_MATERIALS_COMMON,this.lights={};var t=(e.extensions&&e.extensions[d.KHR_MATERIALS_COMMON]||{}).lights||{};for(var r in t){var n,a=t[r],i=a[a.type],s=(new THREE.Color).fromArray(i.color);switch(a.type){case"directional":(n=new THREE.DirectionalLight(s)).position.set(0,0,1);break;case"point":n=new THREE.PointLight(s);break;case"spot":(n=new THREE.SpotLight(s)).position.set(0,0,1);break;case"ambient":n=new THREE.AmbientLight(s)}n&&(this.lights[r]=n)}}function a(e){this.name=d.KHR_BINARY_GLTF;var t=new DataView(e,0,l),r={magic:o(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0),contentLength:t.getUint32(12,!0),contentFormat:t.getUint32(16,!0)};for(var n in E){var a=E[n];if(r[n]!==a)throw new Error('Unsupported glTF-Binary header: Expected "%s" to be "%s".',n,a)}var i=new Uint8Array(e,l,r.contentLength);this.header=r,this.content=o(i),this.body=e.slice(l+r.contentLength,r.length)}function i(e,t,r){if(!e)return Promise.resolve();var n,a=[];if("[object Array]"===Object.prototype.toString.call(e)){n=[];for(var i=e.length,s=0;s<i;s++)(c=t.call(r||this,e[s],s))&&(a.push(c),c instanceof Promise?c.then(function(e,t){n[e]=t}.bind(this,s)):n[s]=c)}else{n={};for(var o in e)if(e.hasOwnProperty(o)){var c=t.call(r||this,e[o],o);c&&(a.push(c),c instanceof Promise?c.then(function(e,t){n[e]=t}.bind(this,o)):n[o]=c)}}return Promise.all(a).then(function(){return n})}function s(e,t){return"string"!=typeof e||""===e?"":/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:new URL((t||"")+e,location.href.substring(0,location.href.lastIndexOf("/")+1)).toString()}function o(e){for(var t="",r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t}function c(){return new THREE.MeshPhongMaterial({color:0,emissive:8947848,specular:0,shininess:0,transparent:!1,depthTest:!0,side:THREE.FrontSide})}function u(e,r,n){this.json=e||{},this.extensions=r||{},this.options=n||{},this.cache=new t}e.prototype={constructor:e,load:function(e,t,r,n){var a=this,i=this.path&&"string"==typeof this.path?this.path:THREE.Loader.prototype.extractUrlBase(e),s=new THREE.FileLoader(a.manager);s.setResponseType("arraybuffer"),s.load(e,function(e){a.parse(e,t,i)},r,n)},setCrossOrigin:function(e){this.crossOrigin=e},setPath:function(e){this.path=e},parse:function(e,t,r){var i,s={};o(new Uint8Array(e,0,4))===E.magic?(s[d.KHR_BINARY_GLTF]=new a(e),i=s[d.KHR_BINARY_GLTF].content):i=o(new Uint8Array(e));var c=JSON.parse(i);c.extensionsUsed&&c.extensionsUsed.indexOf(d.KHR_MATERIALS_COMMON)>=0&&(s[d.KHR_MATERIALS_COMMON]=new n(c)),console.time("GLTFLoader"),new u(c,s,{path:r||this.path,crossOrigin:this.crossOrigin}).parse(function(e,r,n,a){console.timeEnd("GLTFLoader"),t({scene:e,scenes:r,cameras:n,animations:a})})}},e.Shaders={update:function(){console.warn("THREE.GLTFLoader.Shaders has been deprecated, and now updates automatically.")}},r.prototype.update=function(e,t){var r=this.boundUniforms;for(var n in r){var a=r[n];switch(a.semantic){case"MODELVIEW":(s=a.uniform.value).multiplyMatrices(t.matrixWorldInverse,a.sourceNode.matrixWorld);break;case"MODELVIEWINVERSETRANSPOSE":var i=a.uniform.value;this._m4.multiplyMatrices(t.matrixWorldInverse,a.sourceNode.matrixWorld),i.getNormalMatrix(this._m4);break;case"PROJECTION":var s=a.uniform.value;s.copy(t.projectionMatrix);break;case"JOINTMATRIX":for(var o=a.uniform.value,c=0;c<o.length;c++)o[c].getInverse(a.sourceNode.matrixWorld).multiply(a.targetNode.skeleton.bones[c].matrixWorld).multiply(a.targetNode.skeleton.boneInverses[c]).multiply(a.targetNode.bindMatrix);break;default:console.warn("Unhandled shader semantic: "+a.semantic)}}},e.Animations={update:function(){console.warn("THREE.GLTFLoader.Animation has been deprecated. Use THREE.AnimationMixer instead.")}};var d={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_MATERIALS_COMMON:"KHR_materials_common"},E={magic:"glTF",version:1,contentFormat:0},l=20;a.prototype.loadShader=function(e,t){var r=t[e.extensions[d.KHR_BINARY_GLTF].bufferView];return o(new Uint8Array(r))},a.prototype.loadTextureSourceUri=function(e,t){var r=e.extensions[d.KHR_BINARY_GLTF],n=t[r.bufferView],a=o(new Uint8Array(n));return"data:"+r.mimeType+";base64,"+btoa(a)};var p={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,TRIANGLES:4,LINES:1,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,VERTEX_SHADER:35633,FRAGMENT_SHADER:35632},f=(Number,THREE.Matrix3,THREE.Matrix4,THREE.Vector2,THREE.Vector3,THREE.Vector4,THREE.Texture,{5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array}),h={9728:THREE.NearestFilter,9729:THREE.LinearFilter,9984:THREE.NearestMipMapNearestFilter,9985:THREE.LinearMipMapNearestFilter,9986:THREE.NearestMipMapLinearFilter,9987:THREE.LinearMipMapLinearFilter},m={33071:THREE.ClampToEdgeWrapping,33648:THREE.MirroredRepeatWrapping,10497:THREE.RepeatWrapping},R={6406:THREE.AlphaFormat,6407:THREE.RGBFormat,6408:THREE.RGBAFormat,6409:THREE.LuminanceFormat,6410:THREE.LuminanceAlphaFormat},T={5121:THREE.UnsignedByteType,32819:THREE.UnsignedShort4444Type,32820:THREE.UnsignedShort5551Type,33635:THREE.UnsignedShort565Type},v=(THREE.BackSide,THREE.FrontSide,THREE.NeverDepth,THREE.LessDepth,THREE.EqualDepth,THREE.LessEqualDepth,THREE.GreaterEqualDepth,THREE.NotEqualDepth,THREE.GreaterEqualDepth,THREE.AlwaysDepth,THREE.AddEquation,THREE.SubtractEquation,THREE.ReverseSubtractEquation,THREE.ZeroFactor,THREE.OneFactor,THREE.SrcColorFactor,THREE.OneMinusSrcColorFactor,THREE.SrcAlphaFactor,THREE.OneMinusSrcAlphaFactor,THREE.DstAlphaFactor,THREE.OneMinusDstAlphaFactor,THREE.DstColorFactor,THREE.OneMinusDstColorFactor,THREE.SrcAlphaSaturateFactor,{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16}),H={scale:"scale",translation:"position",rotation:"quaternion"},y={LINEAR:THREE.InterpolateLinear,STEP:THREE.InterpolateDiscrete};return function(e){this.isDeferredShaderMaterial=!0,this.params=e}.prototype.create=function(){var e=THREE.UniformsUtils.clone(this.params.uniforms);for(var t in this.params.uniforms){var r=this.params.uniforms[t];r.value instanceof THREE.Texture&&(e[t].value=r.value,e[t].value.needsUpdate=!0),e[t].semantic=r.semantic,e[t].node=r.node}return this.params.uniforms=e,new THREE.RawShaderMaterial(this.params)},u.prototype._withDependencies=function(e){for(var t={},r=0;r<e.length;r++){var n=e[r],a="load"+n.charAt(0).toUpperCase()+n.slice(1),s=this.cache.get(n);if(void 0!==s)t[n]=s;else if(this[a]){var o=this[a]();this.cache.add(n,o),t[n]=o}}return i(t,function(e){return e})},u.prototype.parse=function(e){var t=this.json;this.cache.removeAll(),this._withDependencies(["scenes","cameras","animations"]).then(function(r){var n=[];for(var a in r.scenes)n.push(r.scenes[a]);var i=void 0!==t.scene?r.scenes[t.scene]:n[0],s=[];for(var a in r.cameras){var o=r.cameras[a];s.push(o)}var c=[];for(var a in r.animations)c.push(r.animations[a]);e(i,n,s,c)})},u.prototype.loadShaders=function(){var e=this.json,t=this.extensions,r=this.options;return this._withDependencies(["bufferViews"]).then(function(n){return i(e.shaders,function(e){return e.extensions&&e.extensions[d.KHR_BINARY_GLTF]?t[d.KHR_BINARY_GLTF].loadShader(e,n.bufferViews):new Promise(function(t){var n=new THREE.FileLoader;n.setResponseType("text"),n.load(s(e.uri,r.path),function(e){t(e)})})})})},u.prototype.loadBuffers=function(){var e=this.json,t=this.extensions,r=this.options;return i(e.buffers,function(e,n){return"binary_glTF"===n?t[d.KHR_BINARY_GLTF].body:"arraybuffer"===e.type||void 0===e.type?new Promise(function(t){var n=new THREE.FileLoader;n.setResponseType("arraybuffer"),n.load(s(e.uri,r.path),function(e){t(e)})}):void console.warn("THREE.GLTFLoader: "+e.type+" buffer type is not supported")})},u.prototype.loadBufferViews=function(){var e=this.json;return this._withDependencies(["buffers"]).then(function(t){return i(e.bufferViews,function(e){var r=t.buffers[e.buffer],n=void 0!==e.byteLength?e.byteLength:0;return r.slice(e.byteOffset,e.byteOffset+n)})})},u.prototype.loadAccessors=function(){var e=this.json;return this._withDependencies(["bufferViews"]).then(function(t){return i(e.accessors,function(e){var r=t.bufferViews[e.bufferView],n=v[e.type],a=f[e.componentType],i=a.BYTES_PER_ELEMENT,s=i*n;if(e.byteStride&&e.byteStride!==s){var o=new a(r),c=new THREE.InterleavedBuffer(o,e.byteStride/i);return new THREE.InterleavedBufferAttribute(c,n,e.byteOffset/i)}return o=new a(r,e.byteOffset,e.count*n),new THREE.BufferAttribute(o,n)})})},u.prototype.loadTextures=function(){var e=this.json,t=this.extensions,r=this.options;return this._withDependencies(["bufferViews"]).then(function(n){return i(e.textures,function(a){function i(t){if(t.flipY=!1,void 0!==a.name&&(t.name=a.name),t.format=void 0!==a.format?R[a.format]:THREE.RGBAFormat,void 0!==a.internalFormat&&t.format!==R[a.internalFormat]&&console.warn("THREE.GLTFLoader: Three.js doesn't support texture internalFormat which is different from texture format. internalFormat will be forced to be the same value as format."),t.type=void 0!==a.type?T[a.type]:THREE.UnsignedByteType,a.sampler){var r=e.samplers[a.sampler];t.magFilter=h[r.magFilter]||THREE.LinearFilter,t.minFilter=h[r.minFilter]||THREE.NearestMipMapLinearFilter,t.wrapS=m[r.wrapS]||THREE.RepeatWrapping,t.wrapT=m[r.wrapT]||THREE.RepeatWrapping}}if(a.source)return new Promise(function(o){var c=e.images[a.source],u=c.uri;if(c.extensions&&c.extensions[d.KHR_BINARY_GLTF]&&(u=t[d.KHR_BINARY_GLTF].loadTextureSourceUri(c,n.bufferViews)),altspace&&altspace.inClient)i(a=new THREE.Texture({src:s(u,r.path)})),o(a);else{var E=THREE.Loader.Handlers.get(u);null===E&&(E=new THREE.TextureLoader),E.setCrossOrigin(r.crossOrigin),E.load(s(u,r.path),function(e){i(e),o(e)},void 0,function(){o()})}})})})},u.prototype.loadMaterials=function(){var e=this.json;return this._withDependencies(["shaders","textures"]).then(function(t){return i(e.materials,function(e){var r,n,a={},i={};if(e.extensions&&e.extensions[d.KHR_MATERIALS_COMMON]&&(n=e.extensions[d.KHR_MATERIALS_COMMON]),n){var s=["ambient","emission","transparent","transparency","doubleSided"];switch(n.technique){case"BLINN":case"PHONG":r=THREE.MeshPhongMaterial,s.push("diffuse","specular","shininess");break;case"LAMBERT":r=THREE.MeshLambertMaterial,s.push("diffuse");break;case"CONSTANT":default:r=THREE.MeshBasicMaterial}s.forEach(function(e){void 0!==n.values[e]&&(a[e]=n.values[e])}),(n.doubleSided||a.doubleSided)&&(i.side=THREE.DoubleSide),(n.transparent||a.transparent)&&(i.transparent=!0,i.opacity=void 0!==a.transparency?a.transparency:1)}else r=THREE.MeshPhongMaterial,Object.assign(a,e.values);Array.isArray(a.diffuse)?i.color=(new THREE.Color).fromArray(a.diffuse):"string"==typeof a.diffuse&&(i.map=t.textures[a.diffuse]),delete i.diffuse,"string"==typeof a.reflective&&(i.envMap=t.textures[a.reflective]),"string"==typeof a.bump&&(i.bumpMap=t.textures[a.bump]),Array.isArray(a.emission)?r===THREE.MeshBasicMaterial?i.color=(new THREE.Color).fromArray(a.emission):i.emissive=(new THREE.Color).fromArray(a.emission):"string"==typeof a.emission&&(r===THREE.MeshBasicMaterial?i.map=t.textures[a.emission]:i.emissiveMap=t.textures[a.emission]),Array.isArray(a.specular)?i.specular=(new THREE.Color).fromArray(a.specular):"string"==typeof a.specular&&(i.specularMap=t.textures[a.specular]),void 0!==a.shininess&&(i.shininess=a.shininess);var o=new r(i);return void 0!==e.name&&(o.name=e.name),o})})},u.prototype.loadMeshes=function(){var e=this.json;return this._withDependencies(["accessors","materials"]).then(function(t){return i(e.meshes,function(e){var r=new THREE.Group;void 0!==e.name&&(r.name=e.name),e.extras&&(r.userData=e.extras);var n=e.primitives||[];for(var a in n){var i=n[a];if(i.mode===p.TRIANGLES||void 0===i.mode){var s=new THREE.BufferGeometry,o=i.attributes;for(var u in o){if(!(d=o[u]))return;E=t.accessors[d];switch(u){case"POSITION":s.addAttribute("position",E);break;case"NORMAL":s.addAttribute("normal",E);break;case"TEXCOORD_0":case"TEXCOORD0":case"TEXCOORD":s.addAttribute("uv",E);break;case"TEXCOORD_1":s.addAttribute("uv2",E);break;case"COLOR_0":case"COLOR0":case"COLOR":s.addAttribute("color",E);break;case"WEIGHT":s.addAttribute("skinWeight",E);break;case"JOINT":s.addAttribute("skinIndex",E)}}i.indices&&s.setIndex(t.accessors[i.indices]);f=void 0!==t.materials?t.materials[i.material]:c();(l=new THREE.Mesh(s,f)).castShadow=!0,l.name="0"===a?r.name:r.name+a,i.extras&&(l.userData=i.extras),r.add(l)}else if(i.mode===p.LINES){var s=new THREE.BufferGeometry,o=i.attributes;for(var u in o){var d=o[u];if(!d)return;var E=t.accessors[d];switch(u){case"POSITION":s.addAttribute("position",E);break;case"COLOR_0":case"COLOR0":case"COLOR":s.addAttribute("color",E)}}var l,f=t.materials[i.material];i.indices?(s.setIndex(t.accessors[i.indices]),l=new THREE.LineSegments(s,f)):l=new THREE.Line(s,f),l.name="0"===a?r.name:r.name+a,i.extras&&(l.userData=i.extras),r.add(l)}else console.warn("Only triangular and line primitives are supported")}return r})})},u.prototype.loadCameras=function(){return i(this.json.cameras,function(e){if("perspective"==e.type&&e.perspective){var t=e.perspective.yfov,r=void 0!==e.perspective.aspectRatio?e.perspective.aspectRatio:1,n=t*r,a=new THREE.PerspectiveCamera(THREE.Math.radToDeg(n),r,e.perspective.znear||1,e.perspective.zfar||2e6);return void 0!==e.name&&(a.name=e.name),e.extras&&(a.userData=e.extras),a}if("orthographic"==e.type&&e.orthographic){a=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,e.orthographic.znear,e.orthographic.zfar);return void 0!==e.name&&(a.name=e.name),e.extras&&(a.userData=e.extras),a}})},u.prototype.loadSkins=function(){var e=this.json;return this._withDependencies(["accessors"]).then(function(t){return i(e.skins,function(e){var r=new THREE.Matrix4;return void 0!==e.bindShapeMatrix&&r.fromArray(e.bindShapeMatrix),{bindShapeMatrix:r,jointNames:e.jointNames,inverseBindMatrices:t.accessors[e.inverseBindMatrices]}})})},u.prototype.loadAnimations=function(){var e=this.json;return this._withDependencies(["accessors","nodes"]).then(function(t){return i(e.animations,function(e,r){var n=[];for(var a in e.channels){var i=e.channels[a],s=e.samplers[i.sampler];if(s){var o=i.target,c=o.id,u=void 0!==e.parameters?e.parameters[s.input]:s.input,d=void 0!==e.parameters?e.parameters[s.output]:s.output,E=t.accessors[u],l=t.accessors[d],p=t.nodes[c];if(p){p.updateMatrix(),p.matrixAutoUpdate=!0;var f=H[o.path]===H.rotation?THREE.QuaternionKeyframeTrack:THREE.VectorKeyframeTrack,h=p.name?p.name:p.uuid,m=void 0!==s.interpolation?y[s.interpolation]:THREE.InterpolateLinear;n.push(new f(h+"."+H[o.path],THREE.AnimationUtils.arraySlice(E.array,0),THREE.AnimationUtils.arraySlice(l.array,0),m))}}}c=void 0!==e.name?e.name:"animation_"+r;return new THREE.AnimationClip(c,void 0,n)})})},u.prototype.loadNodes=function(){var e=this.json,t=this.extensions,r=this;return i(e.nodes,function(e){var t,r=new THREE.Matrix4;return e.jointName?((t=new THREE.Bone).name=void 0!==e.name?e.name:e.jointName,t.jointName=e.jointName):(t=new THREE.Object3D,void 0!==e.name&&(t.name=e.name)),e.extras&&(t.userData=e.extras),void 0!==e.matrix?(r.fromArray(e.matrix),t.applyMatrix(r)):(void 0!==e.translation&&t.position.fromArray(e.translation),void 0!==e.rotation&&t.quaternion.fromArray(e.rotation),void 0!==e.scale&&t.scale.fromArray(e.scale)),t}).then(function(n){return r._withDependencies(["meshes","skins","cameras"]).then(function(r){return i(n,function(a,i){var s=e.nodes[i];if(void 0!==s.meshes)for(var o in s.meshes){var c=s.meshes[o],u=r.meshes[c];if(void 0!==u)for(var E in u.children){var l,p=u.children[E],f=p.material,h=p.geometry,m=p.userData,R=p.name;switch(f.isDeferredShaderMaterial?f=l=f.create():l=f,p.type){case"LineSegments":p=new THREE.LineSegments(h,l);break;case"LineLoop":p=new THREE.LineLoop(h,l);break;case"Line":p=new THREE.Line(h,l);break;default:p=new THREE.Mesh(h,l)}p.castShadow=!0,p.userData=m,p.name=R;var T;if(s.skin&&(T=r.skins[s.skin]),T){var v=h;(l=f).skinning=!0,(p=new THREE.SkinnedMesh(v,l,!1)).castShadow=!0,p.userData=m,p.name=R;for(var H=[],y=[],A=0,w=T.jointNames.length;A<w;A++){var g=T.jointNames[A],M=function(e){for(var t=Object.keys(n),r=0,a=t.length;r<a;r++){var i=n[t[r]];if(i.jointName===e)return i}return null}(g);if(M){H.push(M);var L=T.inverseBindMatrices.array,b=(new THREE.Matrix4).fromArray(L,16*A);y.push(b)}else console.warn("WARNING: joint: '"+g+"' could not be found")}p.bind(new THREE.Skeleton(H,y,!1),T.bindShapeMatrix);var O=function(t,r,a){var i=t[a];if(void 0!==i)for(var s=0,o=i.length;s<o;s++){var c=i[s],u=n[c],d=e.nodes[c];void 0!==u&&!0===u.isBone&&void 0!==d&&(r.add(u),O(d,u,"children"))}};O(s,p,"skeletons")}a.add(p)}else console.warn("GLTFLoader: Couldn't find node \""+c+'".')}if(void 0!==s.camera){var S=r.cameras[s.camera];a.add(S)}if(s.extensions&&s.extensions[d.KHR_MATERIALS_COMMON]&&s.extensions[d.KHR_MATERIALS_COMMON].light){var x=t[d.KHR_MATERIALS_COMMON].lights[s.extensions[d.KHR_MATERIALS_COMMON].light];a.add(x)}return a})})})},u.prototype.loadScenes=function(){function e(r,n,a){var i=a[r];n.add(i);var s=t.nodes[r];if(s.children)for(var o=s.children,c=0,u=o.length;c<u;c++)e(o[c],i,a)}var t=this.json;return this._withDependencies(["nodes"]).then(function(n){return i(t.scenes,function(t){var a=new THREE.Scene;void 0!==t.name&&(a.name=t.name),t.extras&&(a.userData=t.extras);for(var i=t.nodes||[],s=0,o=i.length;s<o;s++)e(i[s],a,n.nodes);return a.traverse(function(e){e.material&&e.material.isRawShaderMaterial&&(e.gltfShader=new r(e,n.nodes),e.onBeforeRender=function(e,t,r){this.gltfShader.update(t,r)})}),a})})},e}(),THREE.FileLoader=THREE.FileLoader||THREE.XHRLoader,AFRAME.registerSystem("gltf-model",{init:function(){this.models=[]},registerModel:function(e){this.models.push(e)},unregisterModel:function(e){var t=this.models,r=t.indexOf(e);r>=0&&t.splice(r,1)}}),AFRAME.registerComponent("gltf-model",{schema:{type:"string"},init:function(){this.model=null,this.src=null,this.loader=new THREE.GLTFLoader,this.loader.setCrossOrigin("anonymous")},update:function(){var e=this,t=this.el,r=this.data;r&&r!==this.src&&(this.src=r,this.remove(),this.loader.load(r,function(r){e.model=r.scene,e.system.registerModel(e.model),t.setObject3D("mesh",e.model),t.emit("model-loaded",{format:"gltf",model:e.model})}))},remove:function(){this.model&&(this.el.removeObject3D("mesh"),this.system.unregisterModel(this.model))}}),AFRAME.registerPrimitive("a-gltf-model",{mappings:{src:"gltf-model"}});